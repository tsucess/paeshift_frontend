<!DOCTYPE html>
<html lang="en">
<head>
    <title>Job Chat & Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <h2>Chat Room for Job #{{ job_id }}</h2>
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>
    <input id="messageInput" type="text" style="width: 80%;">
    <button id="sendMessageBtn">Send</button>

    <h2>Client Locations</h2>
    <div id="map" style="height: 500px; width: 100%;"></div>

    <h2>Job Matches</h2>
    <ul id="jobMatches"></ul>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("‚úÖ Document fully loaded");

            const jobId = "{{ job_id }}";
            let chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${jobId}/`);
            let locationSocket = new WebSocket(`ws://${window.location.host}/ws/jobs/${jobId}/location/`);
            let jobMatchingSocket = new WebSocket(`ws://${window.location.host}/ws/job_matching/`);

            let map = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let markers = {};

            // üìç Handling incoming location updates
            locationSocket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                let key = data.user;
                if (markers[key]) {
                    markers[key].setLatLng([data.latitude, data.longitude]).bindPopup(data.address).openPopup();
                } else {
                    markers[key] = L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(data.address).openPopup();
                }
            };

            function sendLocation() {
                if (!navigator.geolocation) {
                    console.error("‚ùå Geolocation is NOT supported by this browser.");
                    alert("Your browser does not support location sharing.");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("‚úÖ Location permission granted:", position);
                        locationSocket.send(JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }));
                    },
                    (error) => {
                        console.error("‚ùå Location error:", error.message);
                        alert("Please allow location access in your browser settings.");
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }

            setInterval(sendLocation, 5000);

            // ‚úÖ Chat WebSocket Handling
            chatSocket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                let messagesDiv = document.getElementById("messages");

                if (data.error) {
                    console.error("‚ùå Chat Error:", data.error);
                    return;
                }

                let newMessage = document.createElement("p");
                newMessage.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
                messagesDiv.appendChild(newMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
            };

            chatSocket.onclose = function(event) {
                console.error("‚ùå Chat WebSocket closed unexpectedly.", event);
            };

            function sendMessage() {
                let messageInput = document.getElementById("messageInput");
                let message = messageInput.value.trim();

                if (message !== "") {
                    chatSocket.send(JSON.stringify({ "message": message }));
                    messageInput.value = "";
                }
            }

            document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);

            // ‚úÖ Job Matching WebSocket
            jobMatchingSocket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                if (data.type === "job_list") {
                    let jobMatches = document.getElementById("jobMatches");
                    jobMatches.innerHTML = "";
                    data.jobs.forEach(job => {
                        let li = document.createElement("li");
                        li.textContent = `${job.title} - ${job.distance} km away`;
                        jobMatches.appendChild(li);
                    });
                }
            };

            jobMatchingSocket.onopen = function() {
                jobMatchingSocket.send(JSON.stringify({ action: "subscribe_jobs" }));
            };
        });
    </script>
</body>
</html>
